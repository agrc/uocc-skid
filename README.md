# UOCC Skid

[![Push Events](https://github.com/agrc/uocc-skid/actions/workflows/push.yml/badge.svg)](https://github.com/agrc/uocc-skid/actions/workflows/push.yml)

Moves data around to support a Survey123 form to replace DEQ's Used Oil Collection Center (UOCC) PDF forms.

This has two distinct ETL pipelines: Google Sheets to Survey123 data CSVs to pre-populate form data and feature service to Google Sheets to extract form responses.

## 1: Sheets to Survey123 Media Folder

DEQ maintains two sheets/tabs of information that are used to update the CSVs holding the UOCC location data and contact information. These are stored in the survey's media folder, and the skid [updates them](https://developers.arcgis.com/survey123/guide/update-contents-of-the-media-folder-for-an-arcgis-survey123-form-item/) using the ArcGIS API for Python.

## 2: Feature Service to Sheets

Survey123 stores all the responses in a single feature service. The skid takes these responses and uses `pygsheets` to add rows to a Google Sheet for each Local Health District (LHD). The skid uses the GlobalID generated by Survey123 to determine which responses need to be added to the sheets.

The skid should never delete rows, but because the row insertion calculates the insertion point after the last row, it is possible that it could overwrite existing data. The feature service should be treated as the ultimate source of truth for the inspection responses.

## Schedule

The skid is scheduled to run every Monday at 3:00 AM

## Make.com Automation

The UOCC project also uses a make.com automation scenario that is triggered via webhook whenever an inspection is completed through Survey123. This automation generates a PDF report from the inspection results, emails it to the UOCC's contact, and saves it to a Google Drive folder for each LHD.

The scenario also monitors the "Request DWMRC assistance" question, and if the response is Yes it will send an email to DWMRC (with the inspector cc'd) containing the report.

